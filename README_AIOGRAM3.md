# Инструкция по установке и запуску Telegram бота с aiogram 3.x

## Общая информация

Этот проект использует aiogram 3.x для создания Telegram бота. Версия 3.x имеет значительные отличия от версии 2.x, поэтому код бота был обновлен соответствующим образом.

## Установка на macOS

1. Убедитесь, что у вас установлен Python 3.7 или выше:
   ```bash
   python3 --version
   ```

2. Сделайте скрипт установки исполняемым:
   ```bash
   chmod +x install_aiogram_macos.sh
   ```

3. Запустите скрипт установки:
   ```bash
   ./install_aiogram_macos.sh
   ```
   Скрипт установит все необходимые зависимости, включая aiogram 3.x.

## Установка на Termux (Android)

1. Установите Termux из [F-Droid](https://f-droid.org/packages/com.termux/) (рекомендуется) или Google Play Store.

2. Запустите Termux и обновите пакеты:
   ```bash
   pkg update && pkg upgrade -y
   ```

3. Установите Git для клонирования репозитория:
   ```bash
   pkg install git -y
   ```

4. Клонируйте репозиторий (или скопируйте файлы вручную):
   ```bash
   git clone https://your-repository-url.git
   cd your-repository-name
   ```

5. Сделайте скрипт установки исполняемым:
   ```bash
   chmod +x install_aiogram_termux_v3.sh
   ```

6. Запустите скрипт установки:
   ```bash
   ./install_aiogram_termux_v3.sh
   ```
   Скрипт установит Python, создаст виртуальное окружение и установит все необходимые зависимости без компиляции.

## Настройка бота

1. Создайте файл .env в корневой директории проекта:
   ```bash
   nano .env
   ```

2. Добавьте следующие строки в файл .env:
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   ADMIN_IDS=["ваш_id_в_телеграм"]
   ```
   Замените `ваш_токен_бота` на токен, полученный от @BotFather, и `ваш_id_в_телеграм` на ваш ID в Telegram.

3. Сохраните файл: нажмите Ctrl+O, затем Enter, затем Ctrl+X для выхода из редактора.

## Запуск бота

1. Активируйте виртуальное окружение (если оно еще не активировано):
   ```bash
   source venv/bin/activate
   ```

2. Запустите бота:
   ```bash
   python bot_telegram_v3.py
   ```

## Советы по использованию в Termux

1. Для запуска бота в фоновом режиме используйте:
   ```bash
   nohup python bot_telegram_v3.py > bot.log 2>&1 &
   ```
   Это позволит боту работать даже после закрытия приложения Termux.

2. Чтобы проверить, запущен ли бот, используйте:
   ```bash
   ps aux | grep python
   ```

3. Для остановки бота найдите его PID и выполните:
   ```bash
   kill PID
   ```
   где PID - идентификатор процесса из предыдущей команды.

4. Для просмотра логов:
   ```bash
   tail -f bot.log
   ```

## Решение проблем

### Общие проблемы

1. **Ошибки импорта модулей**: Убедитесь, что все зависимости установлены правильно:
   ```bash
   pip install -r requirements_v3.txt
   ```

### Проблемы на macOS

1. **Ошибки с Rust**: Если возникают проблемы с компиляцией зависимостей, убедитесь, что Rust установлен:
   ```bash
   brew install rust
   ```

### Проблемы на Termux

1. **Проблемы с SSL**: Если возникают ошибки SSL, убедитесь, что установлен пакет openssl:
   ```bash
   pkg install openssl -y
   ```

2. **Termux засыпает**: Чтобы Termux не засыпал и бот продолжал работать, установите пакет termux-api и используйте wake-lock:
   ```bash
   pkg install termux-api -y
   termux-wake-lock
   ```
   Для отключения: `termux-wake-unlock`

## Основные отличия aiogram 3.x от 2.x

1. Изменена структура импортов и фильтров.
2. Изменен синтаксис регистрации обработчиков.
3. Изменена работа с FSM (конечными автоматами).
4. Изменена структура создания клавиатур.

Подробнее о миграции с aiogram 2.x на 3.x можно прочитать в [официальной документации](https://docs.aiogram.dev/en/latest/migration_guide.html).